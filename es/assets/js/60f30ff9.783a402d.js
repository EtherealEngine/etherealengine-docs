"use strict";(self.webpackChunk_etherealengine_docs=self.webpackChunk_etherealengine_docs||[]).push([[6849],{5360:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>c,frontMatter:()=>a,metadata:()=>r,toc:()=>d});var s=n(4848),o=n(8453);const a={},i=void 0,r={id:"manual/modules/infrastructure/devopsDeployment/AWSSetup/EKS",title:"EKS",description:"Create EKS cluster with four nodegroups",source:"@site/docs/manual/03_modules/05_infrastructure/03_devopsDeployment/03_AWSSetup/02_EKS.md",sourceDirName:"manual/03_modules/05_infrastructure/03_devopsDeployment/03_AWSSetup",slug:"/manual/modules/infrastructure/devopsDeployment/AWSSetup/EKS",permalink:"/etherealengine-docs/es/manual/modules/infrastructure/devopsDeployment/AWSSetup/EKS",draft:!1,unlisted:!1,editUrl:"https://github.com/EtherealEngine/etherealengine-docs/blob/master/docs/manual/03_modules/05_infrastructure/03_devopsDeployment/03_AWSSetup/02_EKS.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{},sidebar:"manual",previous:{title:"Client Files",permalink:"/etherealengine-docs/es/manual/modules/infrastructure/devopsDeployment/AWSSetup/clientFiles"},next:{title:"ECR",permalink:"/etherealengine-docs/es/manual/modules/infrastructure/devopsDeployment/AWSSetup/ECR"}},l={},d=[{value:"Create EKS cluster with four nodegroups",id:"create-eks-cluster-with-four-nodegroups",level:2},{value:"Enable EBS CSI Addon (if EKS version is 1.23 or later)",id:"enable-ebs-csi-addon-if-eks-version-is-123-or-later",level:4},{value:"Install Cluster Autoscaler (optional)",id:"install-cluster-autoscaler-optional",level:4},{value:"Create launch template",id:"create-launch-template",level:4},{value:"Create nodegroup for instanceservers",id:"create-nodegroup-for-instanceservers",level:4},{value:"Create nodegroup for redis",id:"create-nodegroup-for-redis",level:4},{value:"Create nodegroup for builder",id:"create-nodegroup-for-builder",level:4}];function u(e){const t={a:"a",code:"code",h2:"h2",h4:"h4",li:"li",p:"p",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.h2,{id:"create-eks-cluster-with-four-nodegroups",children:"Create EKS cluster with four nodegroups"}),"\n",(0,s.jsxs)(t.p,{children:["You first need to set up an EKS cluster for iR Engine to run on.\nWhile this can be done via AWS' web interface, the ",(0,s.jsx)(t.code,{children:"eksctl"})," CLI\nwill automatically provision more of the services you need automatically,\nand is thus recommended."]}),"\n",(0,s.jsxs)(t.p,{children:["First, follow ",(0,s.jsx)(t.a,{href:"https://docs.aws.amazon.com/eks/latest/userguide/getting-started-eksctl.html",children:"these instructions"}),"\nfor setting up aws-cli, eksctl, and configuring aws-cli with your AWS credentials.\nYou should also set up kubectl and Helm, as we will be using that to install multiple codebases from Charts."]}),"\n",(0,s.jsx)(t.p,{children:"Next run the following command:"}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.code,{children:"eksctl create cluster --name <name> --version <version> --region <region> --managed --nodegroup-name <name> --node-type <instance type> --nodes <target_node_number> --nodes-min <minimum_node_number> --nodes-max <maximum_node_number> --spot"})}),"\n",(0,s.jsx)(t.p,{children:"This will create an EKS cluster with a managed nodegroup in the specified region, including automatically\ncreating subnets, making a VPC, and more. It may take up to 15 minutes to complete."}),"\n",(0,s.jsxs)(t.p,{children:["You can also use the flag ",(0,s.jsx)(t.code,{children:"--zones <zone1>,<zone2>"})," to specify which Availability Zones the cluster\nshould set up in. Some regions have zones that are unavailable, but which eksctl will try to\nuse if --zones is not specified, leading to the setup to fail. As an example, us-west-1 (as of this\nwriting) does not have any resources available in us-west-1b; if you are setting up in us-west-1,\nyou would want to use ",(0,s.jsx)(t.code,{children:"--zones us-west-1a,us-west-1c"}),"."]}),"\n",(0,s.jsx)(t.p,{children:"Note that the region matters for almost all services in AWS. The default region is 'us-east-1',\nbut if you make the cluster in any other region, you'll need to make sure you're creating certs,\nDNS records, etc. in the same region."}),"\n",(0,s.jsxs)(t.p,{children:["As of this writing, the API and client are configured to run on a nodegroup named 'ng-1'.\nIf you name it something else, be sure to change the NodeAffinity in the configuration file. This is one of ",(0,s.jsx)(t.strong,{children:"four"}),"\nnodegroups that will be created for various services to run on."]}),"\n",(0,s.jsx)(t.p,{children:"Make sure to increase the maximum node limit, as by default target, minimum, and maximum are\nset to 2, and iR Engine's setup will definitely need more than two nodes if you've configured\nthem to use relatively small instance types such as t3a.medium."}),"\n",(0,s.jsx)(t.h4,{id:"enable-ebs-csi-addon-if-eks-version-is-123-or-later",children:"Enable EBS CSI Addon (if EKS version is 1.23 or later)"}),"\n",(0,s.jsxs)(t.p,{children:["Follow the instructions ",(0,s.jsx)(t.a,{href:"https://docs.aws.amazon.com/eks/latest/userguide/managing-ebs-csi.html",children:"here"}),"\nto enable an EKS addon that's required for any cluster that will have Persistent Volumes, which an\niR Engine deployment cluster will."]}),"\n",(0,s.jsx)(t.h4,{id:"install-cluster-autoscaler-optional",children:"Install Cluster Autoscaler (optional)"}),"\n",(0,s.jsx)(t.p,{children:"While not necessary, it can be useful to have an autoscaler installed in the cluster to increase\nthe number of nodes available for pods when the cluster has high traffic and to decrease that\nnumber when it has low traffic."}),"\n",(0,s.jsxs)(t.p,{children:["Follow ",(0,s.jsx)(t.a,{href:"https://docs.aws.amazon.com/eks/latest/userguide/autoscaling.html#cluster-autoscaler",children:"these instructions"}),"\nto set up the autoscaler. Any managed nodegroups created in the following steps should by default be\ntagged such that the autoscaler can control them, so no further action should be required."]}),"\n",(0,s.jsx)(t.p,{children:"Note that there is some lag time on scaling up and down. It generally takes about 5 minutes from\nthe time that the autoscaler sees the need to add more nodes before those nodes have been spun up,\nthe appropriate Docker image has been installed onto them, and they are ready to be used. It takes about\n15 minutes for the autoscaler to actually remove nodes that are deemed superfluous, as a hedge against\nthe recent high traffic picking up again."}),"\n",(0,s.jsx)(t.p,{children:"The OIDC provider that was created in the prior step, installing the EBS CSI Addon, can be re-used in this step."}),"\n",(0,s.jsx)(t.h4,{id:"create-launch-template",children:"Create launch template"}),"\n",(0,s.jsx)(t.p,{children:"Go to EC2 -> Launch Templates and make a new one. Name it something like 'etherealengine-production-instanceserver'.\nMost settings can be left as-is, except for the following:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"Storage -> Add a volume, set the size to ~20GB, and for Device name select '/dev/xvda'."}),"\n",(0,s.jsx)(t.li,{children:"Network Interfaces -> Add one, and under 'Auto-assign public IP' select 'Enable'"}),"\n"]}),"\n",(0,s.jsx)(t.h4,{id:"create-nodegroup-for-instanceservers",children:"Create nodegroup for instanceservers"}),"\n",(0,s.jsx)(t.p,{children:"Go to the AWS website, then go to EKS -> Clusters -> click on the cluster you just made -> Configuration -> Compute.\nYou should see one managed nodegroup already there; clicking on its name will open up information\nand editing, though you can't change the instance type after it's been made."}),"\n",(0,s.jsxs)(t.p,{children:["Back at the Compute tab, click on Add Node Group. Pick a name (something like ng-instanceservers-1 is recommended),\nselect the IAM role that was created with the cluster (it should be something like ",(0,s.jsx)(t.code,{children:"eksctl-<cluster_name>-node-NodeInstanceRole-<jumble_of_characters>"}),"),\ntoggle the Use Launch Template toggle and select the launch template you made in the previous step,\nthen click Next. On the second page, Choose the instance type(s) you'd like for the group,\nset the minimum/maximum/desired scaling sizes, and hit Next (t3(a).smalls are recommended).\nThere may be connection issues with instanceserver instances in private subnets, so remove all of the private\nsubnets from the list of subnets to use, and make sure that public subnets are being used (sometimes\nthe workflow only selects private subnets by default). Hit Next, review everything, and click Create."]}),"\n",(0,s.jsx)(t.h4,{id:"create-nodegroup-for-redis",children:"Create nodegroup for redis"}),"\n",(0,s.jsx)(t.p,{children:"Redis should get its own nodegroup to isolate it from any other changes that might be made to your cluster.\nAs with the instanceserver nodegroup, it's not strictly necessary, but can prevent various other things from\ngoing down due to the redis servers getting interrupted."}),"\n",(0,s.jsxs)(t.p,{children:["Back at the Compute tab, click on Add Node Group. Pick a name (the default config in ",(0,s.jsx)(t.a,{href:"https://github.com/EtherealEngine/ethereal-engine-ops/blob/master/configs/local.minikube.template.values.yaml",children:"ethereal-engine-ops"})," assumes\na name of 'ng-redis-1'), select the IAM role that was created with the cluster\n(it should be something like ",(0,s.jsx)(t.code,{children:"eksctl-<cluster_name>-node-NodeInstanceRole-<jumble_of_characters>"}),"),\ntoggle the Use Launch Template toggle and select the launch template used to make the initial nodegroup,\nthen click Next. On the second page, Choose the instance type(s) you'd like for the group,\nset the minimum/maximum/desired scaling sizes (you can probably get away with a single t3(a).small, but it's recommended\nto have at least two nodes so that one going down doesn't kill the entire deployment from a lack of redis), and hit Next.\nThe default subnets should be fine, so hit Next, review everything, and click Create."]}),"\n",(0,s.jsx)(t.h4,{id:"create-nodegroup-for-builder",children:"Create nodegroup for builder"}),"\n",(0,s.jsx)(t.p,{children:"The full iR Engine stack needs a builder server within the cluster in order to bundle and build\niR Engine projects into the codebase that will be deployed. This should run on its own nodegroup\nthat has a single node - only one copy of the builder should ever be running at a time, and\ndue to the high memory needs of building the client service, a box with >8 GB of RAM is needed."}),"\n",(0,s.jsxs)(t.p,{children:["Back at the Compute tab, click on Add Node Group. Pick a name (something like ",(0,s.jsx)(t.code,{children:"ng-dev-builder-1"})," is recommended) and\nselect the IAM role that was created with the cluster (it should be something like\n",(0,s.jsx)(t.code,{children:"eksctl-<cluster_name>-node-NodeInstanceRole-<jumble_of_characters>"}),"). You don't need to use any Launch Template\nfor this nodegroup. Click Next."]}),"\n",(0,s.jsxs)(t.p,{children:["On the second page, you can change the Capacity Type to ",(0,s.jsx)(t.code,{children:"Spot"})," if you want to in order to save money; the builder\nservice will likely not be running very often or for too long, so the odds of it getting interrupted by Spot instance\noutages are low, and it can always re-build if that does happen. Set the Disk Size to 50 GB; it takes a good deal of\ndisk space to install and build the iR Engine codebase, and the default 20 GB will almost certainly not be enough."]}),"\n",(0,s.jsxs)(t.p,{children:["For Instance Types, you need to only select types that have more than 8 GB; t3a.xlarge are the cheapest that fit\nthis criteria. If you were to pick something with 8GB, it's highly likely that most builds would crash the node,\nas Kubernetes tends to restart nodes if they get anywhere near memory capacity.\nUnder Node Group Scaling Configuration, set all three ",(0,s.jsx)(t.code,{children:"nodes"})," values to 1. We only want a single copy of the builder\nat any given time, and running multiple powerful boxes can get pricey. Click Next."]}),"\n",(0,s.jsx)(t.p,{children:"You can leave the subnets on the next page alone and click Next. On the last page, click Create."})]})}function c(e={}){const{wrapper:t}={...(0,o.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(u,{...e})}):u(e)}},8453:(e,t,n)=>{n.d(t,{R:()=>i,x:()=>r});var s=n(6540);const o={},a=s.createContext(o);function i(e){const t=s.useContext(a);return s.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function r(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:i(e.components),s.createElement(a.Provider,{value:t},e.children)}}}]);